---
export interface Props {
  withRects?: boolean;
}

const { withRects = false } = Astro.props;
---
<script is:inline define:vars={{ withRects }}>
  (() => {
    const root = document.documentElement;
    const fixed = (globalThis).__E2E_FIXED_BG__ === true;

    const palettes = ['blue', 'plum', 'forest', 'rust'];
    root.dataset.palette = fixed
      ? 'blue'
      : palettes[Math.floor(Math.random() * palettes.length)];

    if (!withRects) return;

    const setPosPx = (name, x, y) => {
      root.style.setProperty(name + '-x', `${x}px`);
      root.style.setProperty(name + '-y', `${y}px`);
    };

    const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

    const apply = () => {
      const vw = Math.max(320, Math.floor(window.innerWidth || 0));
      const vh = Math.max(480, Math.floor(window.innerHeight || 0));
      const margin = 12;

      const px = (value) => {
        const n = Number.parseFloat(String(value).trim());
        return Number.isFinite(n) ? n : 0;
      };

      const styles = getComputedStyle(root);
      const sizes = {
        s: { w: px(styles.getPropertyValue('--rect-s-w')), h: px(styles.getPropertyValue('--rect-s-h')) },
        m: { w: px(styles.getPropertyValue('--rect-m-w')), h: px(styles.getPropertyValue('--rect-m-h')) },
        l: { w: px(styles.getPropertyValue('--rect-l-w')), h: px(styles.getPropertyValue('--rect-l-h')) }
      };

      const place = (size, minY = margin) => {
        const maxX = Math.max(margin, vw - size.w - margin);
        const maxY = Math.max(minY, vh - size.h - margin);
        return {
          x: randInt(margin, maxX),
          y: randInt(minY, maxY),
          w: size.w,
          h: size.h
        };
      };

      if (fixed) {
        // Deterministic layout for Playwright.
        const s1 = { x: 24, y: Math.min(280, vh - 80), ...sizes.s };
        const s2 = { x: Math.max(24, vw - 140), y: 72, ...sizes.s };
        const s3 = { x: Math.max(24, vw - 160), y: Math.max(72, vh - 160), ...sizes.s };
        const m = { x: Math.max(24, vw - 320), y: Math.floor(vh * 0.4), ...sizes.m };
        const l = { x: Math.max(24, vw - 520), y: Math.floor(vh * 0.72), ...sizes.l };

        setPosPx('--rect-s1', s1.x, s1.y);
        setPosPx('--rect-s2', s2.x, s2.y);
        setPosPx('--rect-s3', s3.x, s3.y);
        setPosPx('--rect-m', m.x, m.y);
        setPosPx('--rect-l', l.x, l.y);
        return;
      }

      // Overlap is allowed (collage feel). Keep a tiny bit of calm at the very top.
      const topPad = 56;
      const large = place(sizes.l, topPad);
      const medium = place(sizes.m, topPad);
      const s1 = place(sizes.s, topPad);
      const s2 = place(sizes.s, topPad);
      const s3 = place(sizes.s, topPad);

      setPosPx('--rect-l', large.x, large.y);
      setPosPx('--rect-m', medium.x, medium.y);
      setPosPx('--rect-s1', s1.x, s1.y);
      setPosPx('--rect-s2', s2.x, s2.y);
      setPosPx('--rect-s3', s3.x, s3.y);
    };

    // Run after layout so we can avoid the real content column.
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      requestAnimationFrame(apply);
    } else {
      window.addEventListener('DOMContentLoaded', () => requestAnimationFrame(apply), { once: true });
    }

    // If Astro View Transitions are enabled later, re-randomize on navigation.
    document.addEventListener('astro:page-load', () => requestAnimationFrame(apply));
  })();
</script>
